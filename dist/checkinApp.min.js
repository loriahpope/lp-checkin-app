var passport=require("passport"),LocalStrategy=require("passport-local").Strategy,mongoose=require("mongoose"),User=mongoose.model("User");passport.use(new LocalStrategy({usernameField:"email"},function(a,b,c){User.findOne({email:a},function(a,d){return a?c(a):d?d.validPassword(b)?c(null,d):c(null,!1,{message:"Password is wrong"}):c(null,!1,{message:"User not found"})})}));var mongoose=require("mongoose"),User=mongoose.model("User");module.exports.profileRead=function(a,b){a.payload._id?User.findById(a.payload._id).exec(function(a,c){b.status(200).json(c)}):b.status(401).json({message:"UnauthorizedError: private profile"})};var mongoose=require("mongoose"),Schema=mongoose.Schema,CheckInSchema=new Schema({title:{type:String,required:!0},created_at:{type:Date,"default":Date.now},updated_at:{type:Date},sentimentScore:Number,sentimentRating:String});module.exports=mongoose.model("CheckIn",CheckInSchema);var mongoose=require("mongoose"),crypto=require("crypto"),jwt=require("jsonwebtoken"),Schema=mongoose.Schema,UserSchema=new Schema({email:{type:String,unique:!0,required:!0},name:{type:String,required:!0},hash:String,salt:String});UserSchema.methods.setPassword=function(a){this.salt=crypto.randomBytes(16).toString("hex"),this.hash=crypto.pbkdf2Sync(a,this.salt,1e3,64).toString("hex")},UserSchema.methods.validPassword=function(a){var b=crypto.pbkdf2Sync(a,this.salt,1e3,64).toString("hex");return this.hash===b},UserSchema.methods.generateJwt=function(){var a=new Date;return a.setDate(a.getDate()+7),jwt.sign({_id:this._id,email:this.email,name:this.name,exp:parseInt(a.getTime()/1e3)},"MY_SECRET")},module.exports=mongoose.model("User",UserSchema),module.exports.register=function(a,b){var c=new User;c.name=a.body.name,c.email=a.body.email,c.setPassword(a.body.password),c.save(function(a){var d;d=c.generateJwt(),b.status(200),b.json({token:d})})},module.exports.login=function(a,b){passport.authenticate("local",function(a,c,d){var e;return a?void b.status(404).json(a):void(c?(e=c.generateJwt(),b.status(200),b.json({token:e})):b.status(401).json(d))})(a,b)},angular.module("checkInApp",["ngRoute"]).config(function(a){a.when("/",{templateUrl:"partials/main.html",controller:"mainCtrl"}).when("/login",{templateUrl:"partials/login.html",controller:"loginCtrl"}).when("/checkIns",{templateUrl:"partials/checkIns.html",controller:"checkInsCtrl"}).when("/checkIns/:checkin_id",{templateUrl:"partials/checkInDetails.html",controller:"checkInDetailsCtrl"})}).controller("mainCtrl",function(a,b,c,d){a.headline="How was your day?",a.tagline="Track your mood in 160 characters per day!",a.maxlength=160,a.formData={},a.createCheckIn=function(){console.log("data:"+a.formData),b.post("http://lp-checkin-app.herokuapp.com/api/checkIns",a.formData).success(function(b){a.formData={},a.checkIns=b,console.log(b),c.location.href="/#/checkIns"}).error(function(a){console.log("Error: "+a)})},a.isActive=function(a){return a===d.path()}}).controller("checkInsCtrl",function(a,b){b.get("http://lp-checkin-app.herokuapp.com/api/checkIns").success(function(b){a.checkIns=b,console.log(b),a.checkInSentiments=[],a.checkInDates=[],a.checkInSentimentRatings=[],a.positiveCheckins=0,a.neutralCheckins=0,a.negativeCheckins=0,angular.forEach(a.checkIns,function(b){a.checkInSentiments.push(b.sentimentScore);var c=new Date(b.created_at);a.checkInDates.push(c.toLocaleDateString()),"Positive"==b.sentimentRating&&a.positiveCheckins++,"Neutral"==b.sentimentRating&&a.neutralCheckins++,"Negative"==b.sentimentRating&&a.negativeCheckins++}),a.checkInSentimentRatings.push({name:"Positive",y:a.positiveCheckins},{name:"Neutral",y:a.neutralCheckins},{name:"Negative",y:a.negativeCheckins}),console.log(a.checkInSentiments),console.log(a.checkInSentimentRatings),Highcharts.chart("sentimentChart",{title:{align:"left",margin:50,text:"Check In Sentiment"},subtitle:{align:"left",text:"Check In Sentiment over Time"},legend:{enabled:!1},yAxis:{max:5,min:-5,title:{text:"Sentiment Values"}},xAxis:{type:"datetime",categories:a.checkInDates,dateTimeLabelFormats:{day:"%e of %b"}},series:[{data:a.checkInSentiments,name:"Sentiment Score",color:"#8087e8",lineWidth:3}]}),new Highcharts.Chart("sentimentChartRatings",{chart:{renderTo:"container",type:"pie"},title:{text:"Sentiment Ratings",margin:50,align:"left"},subtitle:{align:"left",text:"Distribution of Sentiment"},plotOptions:{pie:{shadow:!1}},tooltip:{pointFormat:"<b>{point.percentage:.1f}%</b>"},series:[{name:"Sentiment Ratings",data:[["Positive",a.positiveCheckins],["Neutral",a.neutralCheckins],["Negative",a.negativeCheckins]],colors:["#66BB6A","#5C6BC0","#ef5350"],size:"110%",innerSize:"40%",showInLegend:!0,dataLabels:{enabled:!1}}]})}).error(function(a){console.log("Error: "+a)})}).controller("checkInDetailsCtrl",function(a,b,c,d){b.get("http://lp-checkin-app.herokuapp.com/api/checkIns/"+c.checkin_id).success(function(b){a.checkIn=b,console.log(b)}).error(function(a){console.log("Error: "+a)}),a.deleteCheckIn=function(){b["delete"]("http://lp-checkin-app.herokuapp.com/api/checkIns/"+c.checkin_id).success(function(b){a.checkIns=b,console.log(b),d.location.href="/#/checkIns"}).error(function(a){console.log("Error: "+a)})}}).controller("loginCtrl",function(a,b){a.title="Check In",a.tagline="This is how you've really been doing."});